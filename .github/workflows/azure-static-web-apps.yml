name: Azure Static Web Apps CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ main ]

jobs:
  build_and_deploy:
    # Run for normal pushes, and PRs except when they are being closed
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
      - uses: actions/checkout@v4

      # We build the Functions API ourselves (TypeScript -> JS) so Oryx won't try
      - name: Use Node 18 for API build
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          # intentionally no caching to avoid “paths not resolved” warnings

      # Quick JSON syntax check for each function.json before we compile
      - name: Validate function.json syntax (pre-build)
        shell: bash
        run: |
          set -e
          shopt -s globstar nullglob
          for f in api/**/function.json; do
            echo "Checking JSON: $f"
            node -e "JSON.parse(require('fs').readFileSync(process.argv[1],'utf8'))" "$f"
          done

      # Compile TS -> JS and prune dev deps so the deployed API contains only prod deps
      - name: Build API (ts -> js) and keep only prod deps
        working-directory: api
        shell: bash
        run: |
          set -e
          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --no-audit --no-fund
          fi
          npx tsc -p tsconfig.json
          npm prune --omit=dev

      # Make sure each function.json's scriptFile exists after build (e.g., index.js)
      - name: Validate function.json scriptFile targets (post-build)
        shell: bash
        run: |
          set -e
          shopt -s globstar nullglob
          for f in api/**/function.json; do
            dir="$(dirname "$f")"
            sf="$(node -e "const j=require(process.argv[1]);process.stdout.write((j.scriptFile||'').trim());" "$f")"
            if [ -z "$sf" ]; then
              echo "Error: scriptFile missing in $f"
              exit 1
            fi
            if [ ! -f "$dir/$sf" ]; then
              echo "Error: scriptFile path not found: $dir/$sf (from $f)"
              echo "Directory listing for $dir:"
              ls -la "$dir"
              exit 1
            fi
            echo "OK $f -> $sf"
          done

      # Deploy: skip app & api builds (we already built), and declare the Functions language
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: upload
          app_location: web
          skip_app_build: true
          api_location: api
          skip_api_build: true
          function_language: node
          # If you have a config file under /web, keep this; otherwise remove the next line
          config_file_location: web/staticwebapp.config.json

      # Optional smoke tests (only run if SWA_URL repo variable is set)
      - name: Smoke test API (/api/ping)
        if: ${{ vars.SWA_URL != '' }}
        shell: bash
        run: |
          set -e
          echo "Pinging ${{ vars.SWA_URL }}/api/ping"
          curl -fsSL "${{ vars.SWA_URL }}/api/ping" | tee /tmp/ping.json
          node -e "JSON.parse(require('fs').readFileSync('/tmp/ping.json','utf8'))"

      - name: Smoke test web (home page)
        if: ${{ vars.SWA_URL != '' }}
        shell: bash
        run: |
          set -e
          echo "Fetching ${{ vars.SWA_URL }}/"
          curl -fsS "${{ vars.SWA_URL }}/" | head -c 400 >/dev/null

  # Required by SWA: close PR environments when a PR is closed
  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Close PR Environment
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          action: close
